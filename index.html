<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>我的常用网址（hao123自定义功能·单文件·v8 分类区 + 齿轮管理）</title>
  <style>
    :root{ --bg:#f6f7fb;--panel:#ffffff;--border:#e6e8f0;--text:#16181d;--muted:#6b7280;--shadow:0 8px 24px rgba(0,0,0,.06);--input:#ffffff;--accent:#3b82f6;--danger:#ef4444 }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif}
    .container{max-width:1100px;margin:28px auto;padding:0 16px}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:8px}
    h1{font-size:20px;margin:0}

    /* 顶部操作：纯文本链接（含搜索） */
    .action-links{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .action-link{background:none;border:none;padding:0;color:var(--text);text-decoration:none;cursor:pointer}
    .action-link:hover{color:var(--accent);text-decoration:underline}
    .sep{color:#c0c4d4}

    /* 顶部固定站点导航条 */
    .topnav{display:flex;gap:12px;flex-wrap:wrap;align-items:center;border:1px solid var(--border);background:var(--panel);border-radius:8px;padding:6px 10px;margin:10px 0 6px 0}
    .topnav a{color:var(--text);text-decoration:none;padding:6px 8px;border-radius:6px}
    .topnav a:hover{color:#3b82f6;text-decoration:underline}

    /* 添加/搜索面板（按需展开） */
    .inline-form{display:none;gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px}
    .inline-form .field{display:flex;gap:8px;align-items:center}
    .inline-form label{white-space:nowrap;color:var(--muted)}
    input[type="text"]{width:280px;max-width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--input);color:var(--text)}

    /* 常用网址区域外框 + 齿轮按钮 */
    .links-box{position:relative;border:1px solid var(--border);background:var(--panel);border-radius:8px;padding:8px 10px;margin-top:8px}
    .gear-btn{position:absolute;top:6px;right:6px;border:none;background:transparent;cursor:pointer;color:#9aa0ae;width:28px;height:28px;display:grid;place-items:center;border-radius:6px}
    .gear-btn:hover,.gear-btn.active{color:var(--accent)}
    .gear-btn svg{width:18px;height:18px;fill:currentColor}

    /* 网址列表：纯链接（无卡片背景） */
    .grid{display:grid;grid-template-columns:repeat(auto-fill, 100px);gap:8px;margin-top:4px;justify-content:start}
    .card{display:flex;align-items:center;gap:6px;padding:2px 0;border:none;background:transparent;min-height:24px;cursor:grab;user-select:none}
    .card:active{cursor:grabbing}
    .favicon{width:16px;height:16px;border-radius:4px;object-fit:cover;flex:0 0 16px}
    .link{flex:1;min-width:0;color:var(--text);text-decoration:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px}
    .link:hover,.link:focus{color:#3b82f6;text-decoration:underline}

    /* 拖拽占位 */
    .placeholder{border:2px dashed #94a3b8;border-radius:6px;height:24px;background:transparent}
    .card.dragging{opacity:.5}
    body.dragging .link{pointer-events:none}

    .footer{margin-top:14px;color:var(--muted);display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}

    /* 添加界面中的管理列表（编辑/删除） */
    .manage{display:block;width:100%;margin-top:6px}
    .manage h4{margin:8px 0 6px 0;color:#334155;font-size:13px}
    .manage-list{list-style:none;padding:0;margin:0;max-height:220px;overflow:auto;border:1px solid var(--border);border-radius:8px;background:var(--panel)}
    .manage-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-bottom:1px solid var(--border)}
    .manage-item:last-child{border-bottom:none}
    .manage-name{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mini-link{background:none;border:none;padding:0;margin-left:8px;color:#4b5563;cursor:pointer;text-decoration:none}
    .mini-link:hover{color:#3b82f6;text-decoration:underline}

    /* ===== 分类网址区 ===== */
    .cat-box{position:relative;border:1px solid var(--border);background:var(--panel);border-radius:8px;padding:8px 10px;margin-top:12px}
    .cat-header{display:flex;align-items:center;justify-content:space-between;gap:10px;position:relative;padding-right:40px}
    .cat-tabs{display:flex;overflow:auto;gap:14px;padding:0 4px 2px 0;flex:1;min-width:0}
    .cat-tab{flex:0 0 auto;color:#475569;text-decoration:none;padding:4px 6px;border-radius:4px;cursor:pointer}
    .cat-tab.active{color:#0ea5e9;font-weight:600;border-bottom:2px solid #0ea5e9}
    .cat-more{color:#64748b;text-decoration:none;margin-right:8px}
    .cat-more:hover{color:#3b82f6;text-decoration:underline}
    .cat-gear{position:absolute;top:6px;right:6px;border:none;background:transparent;cursor:pointer;color:#9aa0ae;width:28px;height:28px;display:grid;place-items:center;border-radius:6px}
    .cat-gear:hover,.cat-gear.active{color:var(--accent)}
    .cat-gear svg{width:18px;height:18px;fill:currentColor}
    .grid-cat{display:grid;grid-template-columns:repeat(auto-fill, 100px);gap:8px;margin-top:6px;justify-content:start}

    /* 分类管理区（在齿轮展开内） */
    .cat-manage{display:block;width:100%;margin-top:8px}
    .cat-manage h4{margin:10px 0 6px 0;color:#334155;font-size:13px}
    .cat-list{list-style:none;padding:0;margin:0;border:1px solid var(--border);border-radius:8px;background:var(--panel)}
    .cat-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-bottom:1px solid var(--border)}
    .cat-item:last-child{border-bottom:none}
    .cat-item .cat-name{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .cat-item .mini-link{margin-left:6px}
  </style>
</head>
<body>
  <div class="container" id="appRoot">
    <header>
      <h1>我的常用网址</h1>
      <nav class="action-links">
        <a id="searchToggleBtn" class="action-link" href="#">搜索</a>
        <span class="sep">·</span>
        <a id="exportBtn" class="action-link" href="#">导出</a>
        <span class="sep">·</span>
        <label class="action-link" for="importFile" title="从 JSON 导入">导入</label>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <span class="sep">·</span>
        <a id="resetBtn" class="action-link" href="#">恢复默认</a>
        <span class="sep">·</span>
        <a id="clearBtn" class="action-link" href="#">清空</a>
      </nav>
    </header>

    <nav class="topnav" aria-label="站点导航">
      <a href="https://www.hao123.com/" target="_blank" rel="noopener">hao265推荐</a>
      <a href="https://www.people.com.cn/" target="_blank" rel="noopener">人民网</a>
      <a href="https://www.xinhuanet.com/" target="_blank" rel="noopener">新华网</a>
      <a href="https://www.cctv.com/" target="_blank" rel="noopener">央视网</a>
      <a href="https://www.cri.cn/" target="_blank" rel="noopener">国际在线</a>
      <a href="https://www.chinadaily.com.cn/" target="_blank" rel="noopener">中国日报</a>
      <a href="https://www.china.com.cn/" target="_blank" rel="noopener">中国网</a>
      <a href="https://www.ce.cn/" target="_blank" rel="noopener">中经网</a>
      <a href="https://www.gmw.cn/" target="_blank" rel="noopener">光明网</a>
      <a href="https://www.cnr.cn/" target="_blank" rel="noopener">央广网</a>
      <a href="https://www.qstheory.cn/" target="_blank" rel="noopener">求是网</a>
      <a href="https://www.cyol.com/" target="_blank" rel="noopener">中青网</a>
      <a href="https://www.cac.gov.cn/" target="_blank" rel="noopener">网信网</a>
      <a href="https://www.gov.cn/" target="_blank" rel="noopener">中国政府网</a>
    </nav>

    <!-- 搜索：点击顶部“搜索”后显示 -->
    <section id="searchForm" class="inline-form" aria-hidden="true">
      <div class="field">
        <label for="q">搜索</label>
        <input id="q" type="text" placeholder="输入名称或域名进行过滤…" />
      </div>
      <div style="display:flex;gap:8px">
        <button id="searchCloseBtn" class="action-link" style="border:1px solid var(--border);border-radius:8px;padding:6px 12px;background:transparent">关闭搜索</button>
      </div>
    </section>

    <!-- 常用网址区（保留原有列表 + 齿轮管理） -->
    <section class="links-box">
      <button id="gearBtn" class="gear-btn" aria-label="管理常用网址" title="管理常用网址">
        <svg viewBox="0 0 24 24"><path d="M19.14,12.94a7.49,7.49,0,0,0,.05-.94,7.49,7.49,0,0,0-.05-.94l2.11-1.65a.5.5,0,0,0,.12-.64l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1a7.28,7.28,0,0,0-1.63-.94l-.38-2.65A.5.5,0,0,0,13.7,2H10.3a.5.5,0,0,0-.49.41L9.43,5.06a7.28,7.28,0,0,0-1.63.94l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.5.5,0,0,0,.12.64L4.94,11.06a7.49,7.49,0,0,0-.05.94,7.49,7.49,0,0,0,.05.94L2.83,14.59a.5.5,0,0,0-.12.64l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.28,7.28,0,0,0,1.63.94l.38,2.65a.5.5,0,0,0,.49.41h3.4a.5.5,0,0,0,.49-.41l.38-2.65a7.28,7.28,0,0,0,1.63-.94l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.5.5,0,0,0-.12-.64ZM12,15.5A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/></svg>
      </button>
      <ul id="grid" class="grid" aria-live="polite"></ul>
    </section>

    <!-- 常用网址管理面板（齿轮展开时显示） -->
    <section id="addForm" class="inline-form" aria-hidden="true">
      <div class="field">
        <label for="name">网站名称</label>
        <input id="name" type="text" placeholder="如：Bilibili" />
      </div>
      <div class="field">
        <label for="url">网址</label>
        <input id="url" type="text" placeholder="如：https://www.bilibili.com" />
      </div>
      <div style="display:flex;gap:8px">
        <button id="addConfirmBtn" class="action-link" style="border:1px solid var(--border);border-radius:8px;padding:6px 12px;background:transparent" disabled>确定</button>
        <button id="addCancelBtn" class="action-link" style="border:1px solid var(--border);border-radius:8px;padding:6px 12px;background:transparent">关闭</button>
      </div>
      <div class="manage">
        <h4>管理当前网址（仅在此可编辑/删除）</h4>
        <ul id="manageList" class="manage-list"></ul>
      </div>
    </section>

    <!-- ===== 分类网址区 ===== -->
    <section class="cat-box">
      <div class="cat-header">
        <div id="catTabs" class="cat-tabs" role="tablist" aria-label="分类切换"></div>
        <a id="catMoreBtn" class="cat-more" href="#">点击展开</a>
      </div>
      <button id="catGear" class="cat-gear" aria-label="管理分类网址" title="管理分类网址">
        <svg viewBox="0 0 24 24"><path d="M19.14,12.94a7.49,7.49,0,0,0,.05-.94,7.49,7.49,0,0,0-.05-.94l2.11-1.65a.5.5,0,0,0,.12-.64l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1a7.28,7.28,0,0,0-1.63-.94l-.38-2.65A.5.5,0,0,0,13.7,2H10.3a.5.5,0,0,0-.49.41L9.43,5.06a7.28,7.28,0,0,0-1.63.94l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.5.5,0,0,0,.12.64L4.94,11.06a7.49,7.49,0,0,0-.05.94,7.49,7.49,0,0,0,.05.94L2.83,14.59a.5.5,0,0,0-.12.64l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.28,7.28,0,0,0,1.63.94l.38,2.65a.5.5,0,0,0,.49.41h3.4a.5.5,0,0,0,.49-.41l.38-2.65a7.28,7.28,0,0,0,1.63-.94l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.5.5,0,0,0-.12-.64ZM12,15.5A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/></svg>
      </button>
      <ul id="catGrid" class="grid-cat" aria-live="polite"></ul>
    </section>

    <!-- 分类：添加/编辑面板（仅当前分类） -->
    <section id="catForm" class="inline-form" aria-hidden="true">
      <div class="field">
        <label for="catNameIpt">网站名称</label>
        <input id="catNameIpt" type="text" placeholder="如：Bilibili" />
      </div>
      <div class="field">
        <label for="catUrlIpt">网址</label>
        <input id="catUrlIpt" type="text" placeholder="如：https://www.bilibili.com" />
      </div>
      <div style="display:flex;gap:8px">
        <button id="catAddConfirm" class="action-link" style="border:1px solid var(--border);border-radius:8px;padding:6px 12px;background:transparent" disabled>确定</button>
        <button id="catAddCancel" class="action-link" style="border:1px solid var(--border);border-radius:8px;padding:6px 12px;background:transparent">关闭</button>
      </div>

      <div class="manage">
        <h4>当前分类网址管理</h4>
        <ul id="catManageList" class="manage-list"></ul>
      </div>

      <div class="cat-manage">
        <h4>分类管理</h4>
        <div class="field" style="margin-bottom:6px">
          <label for="newCatIpt">新增分类</label>
          <input id="newCatIpt" type="text" placeholder="如：学习 / AI 工具" style="width:220px" />
          <button id="addCatBtn" class="action-link" style="border:1px solid var(--border);border-radius:8px;padding:6px 12px;background:transparent">添加分类</button>
        </div>
        <ul id="catList" class="cat-list"></ul>
      </div>
    </section>

    <div class="footer">
      <div>✅ 新增“分类网址区”：可标签切换、齿轮管理、仅在面板内编辑删除；常用区仍保持纯链接风格与拖拽排序。</div>
      <div>💡 导入/导出覆盖两块数据；首次会将旧列表迁移到分类的“推荐”中。</div>
    </div>
  </div>

  <script>
    const $ = s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s))
    const STORAGE_KEY='customLinks.v1'           // 常用网址
    const CATS_KEY='customLinks.cats.v1'         // 分类数据
    const ACTIVE_CAT_KEY='customLinks.cats.active'

    function uid(){return (crypto.randomUUID?crypto.randomUUID():'id-'+Math.random().toString(36).slice(2))}
    function ensureHttp(u){ if(!u) return ''; u=u.trim(); if(!/^https?:\/\//i.test(u)) u='https://'+u; return u }
    function faviconUrl(url){ try{ return new URL(url).origin + '/favicon.ico' }catch{ return '' } }

    const defaults=[
      {name:'hao123', url:'https://www.hao123.com/'},{name:'Bing', url:'https://cn.bing.com/'},{name:'Google', url:'https://www.google.com/'},{name:'Toutiao', url:'https://www.toutiao.com/'},{name:'今日热榜', url:'https://tophub.today/'},{name:'知乎', url:'https://www.zhihu.com/'},{name:'抖音', url:'https://www.douyin.com/'},{name:'Bilibili', url:'https://www.bilibili.com/'},{name:'YouTube', url:'https://www.youtube.com/'},{name:'淘宝', url:'https://www.taobao.com/'},{name:'京东', url:'https://www.jd.com/'},{name:'ChatGPT', url:'https://chatgpt.com/'},{name:'Notion', url:'https://www.notion.so/'},{name:'GitHub', url:'https://github.com/'},{name:'Reddit', url:'https://www.reddit.com/'},{name:'Quora', url:'https://www.quora.com/'},{name:'Discord', url:'https://discord.com/'},{name:'Gemini', url:'https://gemini.google.com/app'},{name:'Kimi', url:'https://kimi.moonshot.cn/'},{name:'Claude', url:'https://claude.ai/'}
    ]

    const defaultCatNames=['推荐','视频','汽车','游戏','直播','体育','娱乐','科技','财经','女性','历史','时尚']

    // ===== 常用网址（顶部列表） =====
    let state=loadCommon()
    function loadCommon(){ const raw=localStorage.getItem(STORAGE_KEY); if(raw){ try{ const arr=JSON.parse(raw); return arr.map(x=>({id:x.id||uid(),name:x.name,url:x.url})) }catch{} } const injected=defaults.map(x=>({...x,id:uid()})); localStorage.setItem(STORAGE_KEY, JSON.stringify(injected)); return injected }
    function persistCommon(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)) }

    // 渲染主列表
    const grid=$('#grid')
    function makeCard(link){
      const li=document.createElement('li'); li.className='card'; li.tabIndex=0; li.draggable=true; li.dataset.id=link.id
      li.innerHTML=`<img class="favicon" alt="" src="${faviconUrl(link.url)}" onerror="this.style.display='none'" />
                    <a class="link" href="${link.url}" target="_blank" rel="noopener" title="${link.url}">${link.name}</a>`
      li.setAttribute('draggable','true')
      li.querySelector('.favicon').setAttribute('draggable','false')
      li.querySelector('.link').setAttribute('draggable','false')
      li.addEventListener('dragstart', onDragStart)
      li.addEventListener('dragend', onDragEnd)
      return li
    }
    function renderCommon(){
      const q = ($('#q')?.value||'').trim().toLowerCase()
      grid.innerHTML=''
      state.filter(x=>!q || x.name.toLowerCase().includes(q) || x.url.toLowerCase().includes(q))
           .forEach(link=> grid.appendChild(makeCard(link)))
    }

    // —— 常用：添加/编辑/删除（齿轮面板） ——
    const addForm=$('#addForm'), nameIpt=$('#name'), urlIpt=$('#url'), addConfirmBtn=$('#addConfirmBtn'), addCancelBtn=$('#addCancelBtn'), manageList=$('#manageList'), gearBtn=$('#gearBtn')
    let editingId=null

    function showAddForm(show){
      addForm.style.display=show?'flex':'none'; addForm.setAttribute('aria-hidden', show? 'false':'true'); gearBtn.classList.toggle('active', show)
      addConfirmBtn.textContent = editingId? '保存' : '确定'
      if(show){ nameIpt.focus(); renderManage() } else { clearAddForm() }
    }
    function clearAddForm(){ nameIpt.value=''; urlIpt.value=''; addConfirmBtn.disabled=true; editingId=null }
    function validateAdd(){ const ok = !!nameIpt.value.trim() && /^https?:\/\//i.test(ensureHttp(urlIpt.value)); addConfirmBtn.disabled=!ok }
    nameIpt.addEventListener('input', validateAdd); urlIpt.addEventListener('input', validateAdd)

    function renderManage(){
      manageList.innerHTML=''
      state.forEach(item=>{
        const li=document.createElement('li'); li.className='manage-item'
        li.innerHTML = `<img class="favicon" alt="" src="${faviconUrl(item.url)}" onerror="this.style.display='none'" />
                        <span class="manage-name" title="${item.url}">${item.name}</span>
                        <button class="mini-link" data-act="edit" data-id="${item.id}">编辑</button>
                        <button class="mini-link" data-act="del" data-id="${item.id}">删除</button>`
        manageList.appendChild(li)
      })
    }

    manageList.addEventListener('click', e=>{
      const btn=e.target.closest('.mini-link'); if(!btn) return
      const id=btn.dataset.id; const act=btn.dataset.act; const idx=state.findIndex(x=>x.id===id); if(idx===-1) return
      if(act==='edit'){
        const it=state[idx]; editingId=id; nameIpt.value=it.name; urlIpt.value=it.url; addConfirmBtn.textContent='保存'; validateAdd()
      }else if(act==='del'){
        if(confirm('确定删除该网址吗？')){ state.splice(idx,1); persistCommon(); renderAll() }
      }
    })

    gearBtn.addEventListener('click', ()=> showAddForm(addForm.style.display!=='flex'))
    addCancelBtn.addEventListener('click',()=>{ clearAddForm(); showAddForm(false) })
    addConfirmBtn.addEventListener('click',()=>{
      const name=nameIpt.value.trim(); const url=ensureHttp(urlIpt.value); if(!name||!/^https?:\/\//i.test(url)) return
      if(editingId){ const idx=state.findIndex(x=>x.id===editingId); if(idx>-1){ state[idx].name=name; state[idx].url=url } }
      else{ state.push({id:uid(),name,url}) }
      persistCommon(); renderAll(); clearAddForm()
    })

    // —— 常用：拖拽排序 ——
    let draggingEl=null, placeholder=null
    function createPlaceholder(){ const ph=document.createElement('li'); ph.className='placeholder'; ph.setAttribute('draggable','false'); return ph }
    function onDragStart(e){ const card=e.currentTarget||e.target.closest('.card'); if(!card) return; draggingEl=card; draggingEl.classList.add('dragging'); document.body.classList.add('dragging'); placeholder=createPlaceholder(); draggingEl.parentNode.insertBefore(placeholder, draggingEl); if(e.dataTransfer){ e.dataTransfer.effectAllowed='move'; try{ e.dataTransfer.setData('text/plain','drag') }catch{} } }
    function onDragEnd(){ if(!draggingEl) return; grid.insertBefore(draggingEl, placeholder); draggingEl.classList.remove('dragging'); draggingEl=null; placeholder.remove(); placeholder=null; document.body.classList.remove('dragging'); const order=$$('.card').map(el=>el.dataset.id); state.sort((a,b)=> order.indexOf(a.id)-order.indexOf(b.id)); persistCommon(); renderAll() }
    grid.addEventListener('dragenter', e=>{ if(!draggingEl) return; const over=e.target.closest('.card'); if(over && over!==placeholder) grid.insertBefore(placeholder, over) })
    grid.addEventListener('dragover', e=>{ if(!draggingEl) return; e.preventDefault(); const over=e.target.closest('.card'); if(over){ grid.insertBefore(placeholder, over) } else { grid.appendChild(placeholder) } })
    grid.addEventListener('drop', e=>{ e.preventDefault() })
    grid.addEventListener('dragstart', e=>{ if(e.target?.classList?.contains('card')) onDragStart(e) })
    grid.addEventListener('dragend', e=>{ if(e.target?.classList?.contains('card')) onDragEnd(e) })

    // ===== 分类网址区 =====
    let cats=loadCats(); let activeCatId = localStorage.getItem(ACTIVE_CAT_KEY) || (cats.categories[0]?.id||'')

    function loadCats(){
      const raw = localStorage.getItem(CATS_KEY)
      if(raw){
        try{ const obj=JSON.parse(raw); if(obj&&Array.isArray(obj.categories)&&obj.categories.length){ return obj } }catch{}
      }
      // 初始化：把常用网址作为“推荐”分类导入，其余为空
      const categories = defaultCatNames.map(n=>({ id:uid(), name:n, links:[] }))
      const first = categories[0]; first.links = (state&&state.length? state: defaults).map(x=>({id:uid(), name:x.name, url:x.url}))
      const created = { categories }
      localStorage.setItem(CATS_KEY, JSON.stringify(created))
      return created
    }
    function persistCats(){ localStorage.setItem(CATS_KEY, JSON.stringify(cats)) }

    function setActiveCat(id){ activeCatId=id; localStorage.setItem(ACTIVE_CAT_KEY, id); renderTabs(); renderCatGrid() }
    function getActiveCatIdx(){ return cats.categories.findIndex(c=>c.id===activeCatId) }
    function getActiveCat(){ const i=getActiveCatIdx(); return i>-1? cats.categories[i]: cats.categories[0] }

    // Tabs
    const catTabsEl = $('#catTabs')
    function renderTabs(){
      catTabsEl.innerHTML=''
      cats.categories.forEach(cat=>{
        const a=document.createElement('a'); a.className='cat-tab'+(cat.id===activeCatId?' active':''); a.textContent=cat.name; a.href='#'; a.addEventListener('click', e=>{ e.preventDefault(); setActiveCat(cat.id) })
        catTabsEl.appendChild(a)
      })
    }

    // 分类网址 Grid
    const catGrid=$('#catGrid')
    function makeCatCard(link){
      const li=document.createElement('li'); li.className='card'; li.tabIndex=0; li.draggable=true; li.dataset.id=link.id
      li.innerHTML=`<img class=\"favicon\" alt=\"\" src=\"${faviconUrl(link.url)}\" onerror=\"this.style.display='none'\" />
                    <a class=\"link\" href=\"${link.url}\" target=\"_blank\" rel=\"noopener\" title=\"${link.url}\">${link.name}</a>`
      li.addEventListener('dragstart', e=> onCatDragStart(e))
      li.addEventListener('dragend', ()=> onCatDragEnd())
      return li
    }
    function renderCatGrid(){
      const q = ($('#q')?.value||'').trim().toLowerCase(); const cat=getActiveCat(); if(!cat) return
      catGrid.innerHTML=''
      cat.links.filter(x=>!q || x.name.toLowerCase().includes(q) || x.url.toLowerCase().includes(q))
              .forEach(link=> catGrid.appendChild(makeCatCard(link)))
    }

    // 分类齿轮 + 面板（添加/编辑/删除当前分类网址 & 分类管理）
    const catGear=$('#catGear'), catForm=$('#catForm'), catNameIpt=$('#catNameIpt'), catUrlIpt=$('#catUrlIpt'), catAddConfirm=$('#catAddConfirm'), catAddCancel=$('#catAddCancel'), catManageList=$('#catManageList')
    const catListEl=$('#catList'), newCatIpt=$('#newCatIpt'), addCatBtn=$('#addCatBtn')
    let catEditingId=null

    function showCatForm(show){ catForm.style.display=show?'flex':'none'; catForm.setAttribute('aria-hidden', show? 'false':'true'); catGear.classList.toggle('active', show); if(show){ catNameIpt.focus(); renderCatManage(); renderCatList() } else { clearCatForm() } }
    function clearCatForm(){ catNameIpt.value=''; catUrlIpt.value=''; catAddConfirm.disabled=true; catEditingId=null }
    function validateCatAdd(){ const ok = !!catNameIpt.value.trim() && /^https?:\/\//i.test(ensureHttp(catUrlIpt.value)); catAddConfirm.disabled=!ok }
    catNameIpt.addEventListener('input', validateCatAdd); catUrlIpt.addEventListener('input', validateCatAdd)

    function renderCatManage(){
      const cat=getActiveCat(); catManageList.innerHTML=''
      cat.links.forEach(item=>{
        const li=document.createElement('li'); li.className='manage-item'
        li.innerHTML = `<img class="favicon" alt="" src="${faviconUrl(item.url)}" onerror="this.style.display='none'" />
                        <span class="manage-name" title="${item.url}">${item.name}</span>
                        <button class="mini-link" data-act="edit" data-id="${item.id}">编辑</button>
                        <button class="mini-link" data-act="del" data-id="${item.id}">删除</button>
                        <button class="mini-link" data-act="move" data-id="${item.id}">移动到…</button>`
        catManageList.appendChild(li)
      })
    }

    catManageList.addEventListener('click', e=>{
      const btn=e.target.closest('.mini-link'); if(!btn) return
      const id=btn.dataset.id; const act=btn.dataset.act; const cat=getActiveCat(); const idx=cat.links.findIndex(x=>x.id===id); if(idx===-1) return
      if(act==='edit'){
        const it=cat.links[idx]; catEditingId=id; catNameIpt.value=it.name; catUrlIpt.value=it.url; catAddConfirm.textContent='保存'; validateCatAdd()
      }else if(act==='del'){
        if(confirm('确定删除该网址吗？')){ cat.links.splice(idx,1); persistCats(); renderCatGrid(); renderCatManage() }
      }else if(act==='move'){
        const names=cats.categories.map((c,i)=> `${i+1}. ${c.name}`).join('\n')
        const to=prompt('移动到哪个分类？输入编号:\n'+names)
        const n=parseInt(to,10); if(!n||n<1||n>cats.categories.length) return
        const target=cats.categories[n-1]; const item=cat.links.splice(idx,1)[0]; target.links.push(item); persistCats(); renderCatGrid(); renderCatManage()
      }
    })

    catGear.addEventListener('click', ()=> showCatForm(catForm.style.display!=='flex'))
    catAddCancel.addEventListener('click', ()=>{ clearCatForm(); showCatForm(false) })
    catAddConfirm.addEventListener('click', ()=>{
      const name=catNameIpt.value.trim(); const url=ensureHttp(catUrlIpt.value); if(!name||!/^https?:\/\//i.test(url)) return
      const cat=getActiveCat()
      if(catEditingId){ const idx=cat.links.findIndex(x=>x.id===catEditingId); if(idx>-1){ cat.links[idx].name=name; cat.links[idx].url=url } }
      else{ cat.links.push({id:uid(), name, url}) }
      persistCats(); renderCatGrid(); renderCatManage(); clearCatForm()
    })

    // 分类列表管理（新增/重命名/删除/上移下移）
    function renderCatList(){
      catListEl.innerHTML=''
      cats.categories.forEach((c, i)=>{
        const li=document.createElement('li'); li.className='cat-item'
        li.innerHTML = `<span class="cat-name">${c.name}</span>
                        <button class="mini-link" data-act="rename" data-id="${c.id}">重命名</button>
                        <button class="mini-link" data-act="up" data-id="${c.id}">上移</button>
                        <button class="mini-link" data-act="down" data-id="${c.id}">下移</button>
                        <button class="mini-link" data-act="del" data-id="${c.id}">删除</button>`
        catListEl.appendChild(li)
      })
    }

    addCatBtn.addEventListener('click', ()=>{ const name=(newCatIpt.value||'').trim(); if(!name) return; cats.categories.push({id:uid(), name, links:[]}); newCatIpt.value=''; persistCats(); renderTabs(); renderCatList() })

    catListEl.addEventListener('click', e=>{
      const btn=e.target.closest('.mini-link'); if(!btn) return; const id=btn.dataset.id; const act=btn.dataset.act; const idx=cats.categories.findIndex(x=>x.id===id); if(idx===-1) return
      if(act==='rename'){ const nv=prompt('新的分类名称：', cats.categories[idx].name); if(nv){ cats.categories[idx].name=nv } }
      else if(act==='up'){ if(idx>0){ const t=cats.categories.splice(idx,1)[0]; cats.categories.splice(idx-1,0,t) } }
      else if(act==='down'){ if(idx<cats.categories.length-1){ const t=cats.categories.splice(idx,1)[0]; cats.categories.splice(idx+1,0,t) } }
      else if(act==='del'){ if(cats.categories.length<=1) return alert('至少保留一个分类'); if(confirm('删除分类会移除该分类下的所有网址，确认吗？')){ cats.categories.splice(idx,1); if(activeCatId===id){ activeCatId=cats.categories[0].id } }
      }
      persistCats(); renderTabs(); renderCatList(); renderCatGrid()
    })

    // 分类拖拽排序（仅当前分类内）
    let catDraggingEl=null, catPlaceholder=null
    function catPh(){ const ph=document.createElement('li'); ph.className='placeholder'; return ph }
    function onCatDragStart(e){ const card=e.currentTarget||e.target.closest('.card'); if(!card) return; catDraggingEl=card; catPlaceholder=catPh(); card.parentNode.insertBefore(catPlaceholder, card); if(e.dataTransfer){ e.dataTransfer.effectAllowed='move' } }
    function onCatDragEnd(){ if(!catDraggingEl) return; catGrid.insertBefore(catDraggingEl, catPlaceholder); catPlaceholder.remove(); const order=$$('#catGrid .card').map(el=>el.dataset.id); const cat=getActiveCat(); cat.links.sort((a,b)=> order.indexOf(a.id)-order.indexOf(b.id)); persistCats(); renderCatGrid(); catDraggingEl=null; catPlaceholder=null }
    catGrid.addEventListener('dragover', e=>{ if(!catDraggingEl) return; e.preventDefault(); const over=e.target.closest('.card'); if(over){ catGrid.insertBefore(catPlaceholder, over) } else { catGrid.appendChild(catPlaceholder) } })

    // ===== 搜索（作用于两块） =====
    const searchToggleBtn=$('#searchToggleBtn'), searchForm=$('#searchForm'), qIpt=$('#q'), searchCloseBtn=$('#searchCloseBtn')
    function showSearchForm(show){ searchForm.style.display=show?'flex':'none'; searchForm.setAttribute('aria-hidden', show? 'false':'true'); if(show){ qIpt.focus() } else { qIpt.value=''; renderAll() } }
    searchToggleBtn.addEventListener('click', e=>{ e.preventDefault(); showSearchForm(searchForm.style.display!=='flex') })
    qIpt?.addEventListener('input', ()=> renderAll())
    searchCloseBtn?.addEventListener('click',()=> showSearchForm(false))

    // ===== 导入导出/重置/清空 =====
    $('#exportBtn').addEventListener('click', e=>{ e.preventDefault(); const data=JSON.stringify({version:8,exportedAt:new Date().toISOString(), common:state, cats},null,2); const blob=new Blob([data],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='my-sites.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500) })
    $('#importFile').addEventListener('change',async e=>{ const f=e.target.files?.[0]; if(!f) return; try{ const obj=JSON.parse(await f.text()); if(obj.cats && obj.common){ cats=obj.cats; state=obj.common } else if(obj.items){ state=obj.items } else if(Array.isArray(obj)){ state=obj } else { throw new Error('文件格式不正确') } persistCommon(); persistCats(); renderAll(); renderCatList(); renderTabs() }catch(err){ alert('导入失败：'+err.message) } finally{ e.target.value='' } })
    $('#resetBtn').addEventListener('click', e=>{ e.preventDefault(); if(confirm('恢复到默认站点列表与默认分类？')){ state=defaults.map(x=>({...x,id:uid()})); const categories=defaultCatNames.map(n=>({id:uid(),name:n,links:[]})); categories[0].links=defaults.map(x=>({id:uid(),name:x.name,url:x.url})); cats={categories}; activeCatId=categories[0].id; persistCommon(); persistCats(); renderAll(); renderTabs(); renderCatList() } })
    $('#clearBtn').addEventListener('click', e=>{ e.preventDefault(); if(confirm('确认清空全部网址（常用与分类）？')){ state=[]; cats.categories.forEach(c=> c.links=[]); persistCommon(); persistCats(); renderAll(); renderCatList() } })

    // ===== Tabs 展开/收起（仅样式提示） =====
    $('#catMoreBtn').addEventListener('click', e=>{ e.preventDefault(); const el=$('#catTabs'); if(el.style.whiteSpace==='normal'){ el.style.whiteSpace='nowrap'; e.target.textContent='点击展开' } else { el.style.whiteSpace='normal'; e.target.textContent='点击收起' } })

    function renderAll(){ renderCommon(); renderCatGrid() }

    // ===== 启动 =====
    renderTabs(); setActiveCat(activeCatId); renderAll();
  </script>
</body>
</html>